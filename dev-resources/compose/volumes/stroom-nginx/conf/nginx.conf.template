user  nginx;

# If you have a dedicated nginx host, consider setting this to 'auto' so 
# that nginx will try to use one worker per core. Alternatively set it to
# an explicit value that doesn't exceed one worker per core.
worker_processes  1;

events {
    # The maximum number of simultaneous connections that can be opened by a 
    # worker process
    worker_connections  1024;
}

http {
    # Include generic logging configuration
    include logging.conf;

    # Create a cache for caching responses from upstream
    proxy_cache_path /var/nginx/cache/stroom_cache keys_zone=stroom_cache:10m levels=1:2 inactive=600s max_size=100m use_temp_path=off;

    upstream stroom_upstream_sticky { 
        ip_hash;
        include upstreams.stroom.ui.conf;
    }

    upstream stroom_upstream {
        include upstreams.stroom.processing.conf;
    }

    upstream auth_service_upstream_sticky {
        ip_hash;
        include upstreams.auth.service.conf;
    }

    upstream auth_ui_upstream {
        include upstreams.auth.ui.conf;
    }

    upstream stroom_proxy_upstream { 
        include upstreams.proxy.conf;
    }

    # Define valid index page filenames
    index index.html index.htm;

    # Necessary where we have long server names, i.e. aws.
    # Increasing by default because I'm not clear of the downsides?
    server_names_hash_bucket_size 128;

    # Redirect all http traffic to https
    server {
        listen 80 default_server;
        server_name _;
        return 301 https://$host$request_uri;
    }
    
    server {
        # Include generic server configuration
        include server.conf;

        # Include location configuration specific to stroom
        include locations.stroom.conf;

        # Include location configuration specific to auth
        include locations.auth.conf;

        # Include location configuration specific to proxy
        include locations.proxy.conf;

        # ########### IF_development-only_IN_STACK ###########
        # This conditional block will be removed in a stack release
        # as development-only is not a valid service
        # See create_stack_assets.sh

        # Include location configuration specific to dev.
        # Should not be included in production deployments.
        # Supports hot-loading for stroom-ui
        include locations.dev.conf;
        # ########### FI_development-only_IN_STACK ###########
    }
}

# vim: set filetype=text shiftwidth=4 tabstop=4 expandtab:
